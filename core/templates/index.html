<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MQTT Sensor Dashboard</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            padding: 20px;
        }

        h2 {
            margin-bottom: 10px;
        }

        /* ===== DASHBOARD CARDS ===== */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

       .card {
            background: #ffffff;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
            min-height: 100px;
        }


        .card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 6px;
        }

        .card-value {
            font-size: 26px;
            font-weight: bold;
        }

        .status {
            color: green;
            font-weight: bold;
            margin-top: 5px;
            font-size: 13px;
        }

        /* ===== GRAPHS ===== */
        .graphs {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        canvas {
            width: 100% !important;
            height: 220px !important;
        }

        .graph-card {
            background: #fff;
            padding: 15px;
            width: 32%;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        /* ===== TABLE ===== */
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        th {
            background: #343a40;
            color: #fff;
        }

        tr:nth-child(even) {
            background: #f2f2f2;
        }
    </style>
</head>
<body>

<!-- ================= HEADER ================= -->
<h2>Live MQTT Sensor Dashboard</h2>
<div class="status">● Auto-refresh every 2 seconds</div>

<!-- ================= CARDS ================= -->
<div class="dashboard">

    <div class="card">
        <div class="card-title">Device</div>
        <div class="card-value" id="device">esp32_0</div>
        <div class="status">Connected</div>
    </div>

    <div class="card">
        <div class="card-title">Temperature (°C)</div>
        <div class="card-value" id="temp">--</div>
    </div>

    <div class="card">
        <div class="card-title">Humidity (%)</div>
        <div class="card-value" id="hum">--</div>
    </div>

    <div class="card">
        <div class="card-title">Light Sensor</div>
        <div class="card-value" id="light">--</div>
    </div>

    <div class="card">
        <div class="card-title">Last Update</div>
        <div class="card-value" style="font-size:14px" id="time">--</div>
    </div>

</div>

<!-- ================= GRAPHS ================= -->
<h2>Sensor Graphs</h2>

<div class="graphs">
    <div class="graph-card">
        <h3>Temperature (°C)</h3>
        <canvas id="tempChart"></canvas>
    </div>

    <div class="graph-card">
        <h3>Humidity (%)</h3>
        <canvas id="humChart"></canvas>
    </div>

    <div class="graph-card">
        <h3>Light Sensor</h3>
        <canvas id="lightChart"></canvas>
    </div>
</div>

<!-- ================= TABLE ================= -->
<h2>Continuous Sensor Data</h2>

<table>
    <thead>
        <tr>
            <th>Timestamp</th>
            <th>Temperature (°C)</th>
            <th>Humidity (%)</th>
            <th>Light Sensor</th>
        </tr>
    </thead>
    <tbody id="sensor-table-body">
        <tr>
            <td colspan="4">Waiting for data...</td>
        </tr>
    </tbody>
</table>

<!-- ================= LIVE DATA SCRIPT ================= -->
<script>
let lastTimestamp = null;

async function fetchLiveData() {
    try {
        const response = await fetch("/api/data/");
        const jsonData = await response.json();
        const esp32 = jsonData["esp32_0"];
        if (!esp32) return;

        // Update cards
        document.getElementById("temp").innerText = esp32.Temperature ?? "--";
        document.getElementById("hum").innerText = esp32.Humidity ?? "--";
        document.getElementById("light").innerText = esp32["Light Sensor"] ?? "--";
        document.getElementById("time").innerText = esp32.timestamp ?? "--";

        // Table update
        if (esp32.timestamp !== lastTimestamp) {
            lastTimestamp = esp32.timestamp;

            const tbody = document.getElementById("sensor-table-body");

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${esp32.timestamp}</td>
                <td>${esp32.Temperature ?? "—"}</td>
                <td>${esp32.Humidity ?? "—"}</td>
                <td>${esp32["Light Sensor"] ?? "—"}</td>
            `;

            if (tbody.textContent.includes("Waiting")) tbody.innerHTML = "";
            tbody.prepend(row);
            if (tbody.children.length > 20) tbody.removeChild(tbody.lastChild);
        }

    } catch (err) {
        console.error("Live data error:", err);
    }
}

fetchLiveData();
setInterval(fetchLiveData, 5000);
</script>

<!-- ================= CHART SCRIPT ================= -->
<script>
function createChart(id, label, color, yLabel) {
    return new Chart(document.getElementById(id), {
        type: "line",
        data: { labels: [], datasets: [{ label, data: [], borderColor: color, tension: 0.2 }] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { title: { display: true, text: "Time" }},
                y: { title: { display: true, text: yLabel }}
            }
        }
    });
}

const tempChart  = createChart("tempChart", "Temperature", "red", "°C");
const humChart   = createChart("humChart", "Humidity", "blue", "%");
const lightChart = createChart("lightChart", "Light Sensor", "green", "Value");

async function loadGraphs() {
    const res = await fetch("/api/graph-data/");
    const data = await res.json();
    if (!data.labels?.length) return;

    tempChart.data.labels = data.labels;
    humChart.data.labels = data.labels;
    lightChart.data.labels = data.labels;

    tempChart.data.datasets[0].data = data.temperature;
    humChart.data.datasets[0].data = data.humidity;
    lightChart.data.datasets[0].data = data.light;

    tempChart.update();
    humChart.update();
    lightChart.update();
}

loadGraphs();
setInterval(loadGraphs, 60000);
</script>

</body>
</html>

